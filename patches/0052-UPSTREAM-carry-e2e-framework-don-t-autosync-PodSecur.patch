From 0612d76a5735883ec9d4404fbd6366876b3233d6 Mon Sep 17 00:00:00 2001
From: Stanislav Laznicka <slaznick@redhat.com>
Date: Thu, 19 May 2022 13:49:49 +0200
Subject: [PATCH] UPSTREAM: <carry>: e2e-framework: don't autosync PodSecurity
 labels

In the tests, we oftentimes create pods directly by the administrative
user and so their SCC-related privileges are being used to create the
pods. The PSa label syncher however works by introspecting SAs in each
namespace, and since the SAs in the direct pod creation use-cases don't
have the SCC-related privileges, the labelsyncer evaluates these
namespaces as "restricted" because only the "restricted-v2" SCC is ever
assigned in the namespaces. This breaks tests where pods are created
directly.

OpenShift-Rebase-Source: 4b7ae5621c4
---
 test/e2e/framework/framework.go | 3 +++
 1 file changed, 3 insertions(+)

diff --git a/test/e2e/framework/framework.go b/test/e2e/framework/framework.go
index ecd54705939..d1f8912a3cc 100644
--- a/test/e2e/framework/framework.go
+++ b/test/e2e/framework/framework.go
@@ -453,6 +453,9 @@ func (f *Framework) CreateNamespace(ctx context.Context, baseName string, labels
 		enforceLevel = f.NamespacePodSecurityEnforceLevel
 	}
 	labels[admissionapi.EnforceLevelLabel] = string(enforceLevel)
+	// turn off the OpenShift label syncer so that it does not attempt to sync
+	// the PodSecurity admission labels
+	labels["security.openshift.io/scc.podSecurityLabelSync"] = "false"
 
 	ns, err := createTestingNS(ctx, baseName, f.ClientSet, labels)
 	// check ns instead of err to see if it's nil as we may
-- 
2.40.1


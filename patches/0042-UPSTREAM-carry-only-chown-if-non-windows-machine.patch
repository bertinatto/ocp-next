From a3308f640afcd0a24d57a6818ec9530ddd95e2b0 Mon Sep 17 00:00:00 2001
From: Ryan Phillips <ryan@trolocsis.com>
Date: Fri, 11 Jun 2021 15:27:56 -0500
Subject: [PATCH] UPSTREAM: <carry>: only chown if non-windows machine

Upstream worked on under https://github.com/kubernetes/kubernetes/pull/102868

OpenShift-Rebase-Source: 5032546e78b
---
 pkg/volume/util/atomic_writer.go | 9 ++++++---
 1 file changed, 6 insertions(+), 3 deletions(-)

diff --git a/pkg/volume/util/atomic_writer.go b/pkg/volume/util/atomic_writer.go
index 91ee77a9f69..7f5e520b5ea 100644
--- a/pkg/volume/util/atomic_writer.go
+++ b/pkg/volume/util/atomic_writer.go
@@ -400,6 +400,7 @@ func (w *AtomicWriter) newTimestampDir() (string, error) {
 // writePayloadToDir writes the given payload to the given directory.  The
 // directory must exist.
 func (w *AtomicWriter) writePayloadToDir(payload map[string]FileProjection, dir string) error {
+	isNotWindows := runtime.GOOS != "windows"
 	for userVisiblePath, fileProjection := range payload {
 		content := fileProjection.Data
 		mode := os.FileMode(fileProjection.Mode)
@@ -427,9 +428,11 @@ func (w *AtomicWriter) writePayloadToDir(payload map[string]FileProjection, dir
 		if fileProjection.FsUser == nil {
 			continue
 		}
-		if err := os.Chown(fullPath, int(*fileProjection.FsUser), -1); err != nil {
-			klog.Errorf("%s: unable to change file %s with owner %v: %v", w.logContext, fullPath, int(*fileProjection.FsUser), err)
-			return err
+		if isNotWindows {
+			if err := os.Chown(fullPath, int(*fileProjection.FsUser), -1); err != nil {
+				klog.Errorf("%s: unable to change file %s with owner %v: %v", w.logContext, fullPath, int(*fileProjection.FsUser), err)
+				return err
+			}
 		}
 	}
 
-- 
2.40.1


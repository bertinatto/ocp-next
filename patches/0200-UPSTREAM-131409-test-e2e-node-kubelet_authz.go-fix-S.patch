From fd7da8c8a10cc9b91a6ccfcd5da8ba8059e2407c Mon Sep 17 00:00:00 2001
From: Fabio Bertinatto <fbertina@redhat.com>
Date: Fri, 25 Apr 2025 16:20:30 -0300
Subject: [PATCH] UPSTREAM: 131409: test/e2e/node/kubelet_authz.go: fix SAR to
 include service account groups

---
 test/e2e/framework/auth/helpers.go | 3 ++-
 test/e2e/node/kubelet_authz.go     | 5 +++++
 2 files changed, 7 insertions(+), 1 deletion(-)

diff --git a/test/e2e/framework/auth/helpers.go b/test/e2e/framework/auth/helpers.go
index 28a12c7ba6c..6312e737c3d 100644
--- a/test/e2e/framework/auth/helpers.go
+++ b/test/e2e/framework/auth/helpers.go
@@ -45,11 +45,12 @@ type bindingsGetter interface {
 
 // WaitForAuthzUpdate checks if the give user can perform named verb and action
 // on a resource or subresource.
-func WaitForAuthzUpdate(ctx context.Context, c v1authorization.SubjectAccessReviewsGetter, user string, ra *authorizationv1.ResourceAttributes, allowed bool) error {
+func WaitForAuthzUpdate(ctx context.Context, c v1authorization.SubjectAccessReviewsGetter, user string, groups []string, ra *authorizationv1.ResourceAttributes, allowed bool) error {
 	review := &authorizationv1.SubjectAccessReview{
 		Spec: authorizationv1.SubjectAccessReviewSpec{
 			ResourceAttributes: ra,
 			User:               user,
+			Groups:             groups,
 		},
 	}
 
diff --git a/test/e2e/node/kubelet_authz.go b/test/e2e/node/kubelet_authz.go
index 88972e6d30d..44a633fa0a0 100644
--- a/test/e2e/node/kubelet_authz.go
+++ b/test/e2e/node/kubelet_authz.go
@@ -104,6 +104,11 @@ func runKubeletAuthzTest(ctx context.Context, f *framework.Framework, endpoint,
 
 	err = e2eauth.WaitForAuthzUpdate(ctx, f.ClientSet.AuthorizationV1(),
 		serviceaccount.MakeUsername(ns, saName),
+		[]string{
+			"system:authenticated",
+			"system:serviceaccounts",
+			fmt.Sprintf("system:serviceaccounts:%s", ns),
+		},
 		&authorizationv1.ResourceAttributes{
 			Namespace:   ns,
 			Verb:        verb,
-- 
2.49.0


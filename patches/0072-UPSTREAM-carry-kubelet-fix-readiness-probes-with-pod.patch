From 0bf630f39f23b3b1a579b21ca4be60bcb5ff6ea5 Mon Sep 17 00:00:00 2001
From: Fabio Bertinatto <fbertina@redhat.com>
Date: Mon, 12 Jun 2023 18:23:36 -0300
Subject: [PATCH] UPSTREAM: <carry>: kubelet: fix readiness probes with pod
 termination

---
 test/e2e_node/mirror_pod_readiness_test.go | 9 +++++++--
 1 file changed, 7 insertions(+), 2 deletions(-)

diff --git a/test/e2e_node/mirror_pod_readiness_test.go b/test/e2e_node/mirror_pod_readiness_test.go
index 62586e3228e..817bc70e52d 100644
--- a/test/e2e_node/mirror_pod_readiness_test.go
+++ b/test/e2e_node/mirror_pod_readiness_test.go
@@ -23,6 +23,7 @@ import (
 	"time"
 
 	"fmt"
+
 	v1 "k8s.io/api/core/v1"
 	metav1 "k8s.io/apimachinery/pkg/apis/meta/v1"
 	"k8s.io/apimachinery/pkg/util/uuid"
@@ -44,10 +45,14 @@ var _ = SIGDescribe("MirrorPod", func() {
 			staticPodName = "static-pod-" + string(uuid.NewUUID())
 			mirrorPodName = staticPodName + "-" + framework.TestContext.NodeName
 
-			podPath = framework.TestContext.KubeletConfig.StaticPodPath
+			getCurrentKubeletConfig(ctx)
+
+			kubeletCfg, err := getCurrentKubeletConfig(ctx)
+			framework.ExpectNoError(err)
+			podPath = kubeletCfg.StaticPodPath
 
 			ginkgo.By("create the static pod")
-			err := createStaticPodWithReadiness(podPath, staticPodName, ns,
+			err = createStaticPodWithReadiness(podPath, staticPodName, ns,
 				imageutils.GetE2EImage(imageutils.Perl), v1.RestartPolicyAlways)
 			framework.ExpectNoError(err)
 
-- 
2.40.1

